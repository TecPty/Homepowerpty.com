// Remove stray replacement characters (ï¿½) that slipped due to encoding
document.addEventListener('DOMContentLoaded', () => {
  const decodeEntities = (str) => {
    const t = document.createElement('textarea');
    t.innerHTML = str;
    return t.value;
  };

  const replacements = [
    [/ÃƒÂ¡/g, 'Ã¡'], [/ÃƒÂ©/g, 'Ã©'], [/ÃƒÂ­/g, 'Ã­'], [/ÃƒÂ³/g, 'Ã³'], [/ÃƒÂº/ g, 'Ãº'], [/ÃƒÂ±/g, 'Ã±'],
    [/ÃƒÂ/g, 'Ã'], [/Ãƒâ€°/g, 'Ã‰'], [/ÃƒÃ/g, 'Ã'], [/Ãƒâ€œ/g, 'Ã“'], [/ÃƒÅ¡/g, 'Ãš'], [/Ãƒâ€˜/g, 'Ã‘'],
    [/Ãƒâ€šÃ‚Â°/g, 'Â°'], [/Ã‚Â°/g, 'Â°'],
    [/ÃƒÆ’Ã‚Â¡/g, 'Ã¡'], [/ÃƒÆ’Ã‚Â©/g, 'Ã©'], [/ÃƒÆ’Ã‚Â­/g, 'Ã­'], [/ÃƒÆ’Ã‚Â³/g, 'Ã³'], [/ÃƒÆ’Ã‚Âº/ g, 'Ãº'], [/ÃƒÆ’Ã‚Â±/g, 'Ã±'],
    [/ElectrodomÃƒÂ©sticos/g, 'ElectrodomÃ©sticos'],
    [/TecnologÃƒÂ­a/g, 'TecnologÃ­a'],
    [/PanamÃƒÂ¡/g, 'PanamÃ¡'],
    [/FunciÃƒÂ³n/g, 'FunciÃ³n'],
    [/garantÃƒÂ­a/g, 'garantÃ­a'],
    [/aÃƒÂ±o/g, 'aÃ±o'],
    [/MÃƒÂ¡s/g, 'MÃ¡s'],
    [/rÃƒÂ¡pido/g, 'rÃ¡pido'],
    [/TelÃƒÂ©fono/g, 'TelÃ©fono'],
    [/LogÃƒÂ­stica/g, 'LogÃ­stica'],
    [/AdministraciÃƒÂ³n/g, 'AdministraciÃ³n'],
    [/PosiciÃƒÂ³n/g, 'PosiciÃ³n'],
    [/AplicaciÃƒÂ³n/g, 'AplicaciÃ³n'],
    [/PresiÃƒÂ³n/g, 'PresiÃ³n'],
    [/CampeÃƒÂ³n/g, 'CampeÃ³n'],
    [/TitÃƒÂ¡n/g, 'TitÃ¡n'],
    [/AlmacÃƒÂ©n/g, 'AlmacÃ©n'],
    [/QuemaÃƒÂ±ores/g, 'Quemadores'],
    [/giraÃƒÂ±orio/g, 'giratorio'],
    [/ApagaÃƒÂ±o/g, 'Apagado'],
    [/vaÃƒÂ±or/g, 'vapor'],
    [/DepÃƒÂ³sito/g, 'DepÃ³sito'],
    [/piezoelÃƒÂ©ctrico/g, 'piezoelÃ©ctrico'],
    [/VÃƒÂ¡lvulas/g, 'VÃ¡lvulas'],
    [/vÃƒÂ¡lvula/g, 'vÃ¡lvula'],
    [/SÃƒÂ­guenos/g, 'SÃ­guenos']
  ];

  const normalize = (txt) => {
    if (!txt) return txt;
    let out = decodeEntities(txt).replace(/\uFFFD/g, '');
    for (const [re, rep] of replacements) out = out.replace(re, rep);
    return out;
  };

  // Fix text nodes
  const walker = document.createTreeWalker(document.body, NodeFilter.SHOW_TEXT, null);
  const nodes = [];
  while (walker.nextNode()) nodes.push(walker.currentNode);
  nodes.forEach(n => { n.nodeValue = normalize(n.nodeValue); });

  // Fix common attributes
  const attrTargets = ['alt', 'title', 'placeholder', 'aria-label', 'value'];
  document.querySelectorAll('*').forEach(el => {
    attrTargets.forEach(attr => {
      if (el.hasAttribute && el.hasAttribute(attr)) {
        const v = el.getAttribute(attr);
        const nv = normalize(v);
        if (nv !== v) el.setAttribute(attr, nv);
      }
    });
  });
});
